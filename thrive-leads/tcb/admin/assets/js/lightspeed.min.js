(()=>{var e={229:(e,t,i)=>{const o=i(89207),r=i(59209);e.exports=Backbone.View.extend({events:{"click .lightspeed-optimize":"optimize","click .lightspeed-force-optimize":"forceOptimize"},initialize(){this.$toggle=new r},render(){const e={totalItems:o.getTotalItems(),optimizedItems:o.getOptimizedItems()},t=this.getState(e.optimizedItems,e.totalItems);return this.$el.html(o.tpl(`optimization/${t}-optimized`,e)),"not"!==t&&this.$(".page-footer").html(this.$toggle.render()),this},optimize(){Lightspeed.router.navigate("#optimization/optimize",{trigger:!0})},forceOptimize(){Lightspeed.collections.forEach(e=>e.resetOptimization()),this.optimize()},getState(e=0,t=0){let i;switch(!0){case 0===e:i="not";break;case e===t:i="all";break;default:i="partially"}return i}})},1453:(e,t,i)=>{function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,o)}return i}function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){s(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function s(e,t,i){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const n=i(89207);e.exports=Backbone.View.extend({events:{"click .ls-setting-input":"toggleOption"},render(){this.$el.html(n.tpl("fonts/main",r(r({},Lightspeed.CONST.options),{},{canOptimizeFonts:!Lightspeed.CONST.options.tve_google_fonts_disable_api_call,canLoadFontsAsync:!Lightspeed.CONST.options.tve_google_fonts_disable_api_call&&Lightspeed.CONST.options._tve_enable_fonts_optimization})))},toggleOption(e){const t=e.currentTarget.dataset.key,i=e.currentTarget.checked?1:0;switch(t){case"tve_google_fonts_disable_api_call":i&&(this.updateOption("_tve_enable_fonts_optimization",0),this.updateOption("_tve_enable_fonts_async_load",0));break;case"_tve_enable_fonts_optimization":i||this.updateOption("_tve_enable_fonts_async_load",0)}this.updateOption(t,i)},updateOption(e,t){n.ajax("options","POST",{key:e,value:t}).then(()=>{Lightspeed.CONST.options[e]=t,"fonts/main"===Backbone.history.fragment&&this.render()})}})},5840:(e,t,i)=>{function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,o)}return i}function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){s(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function s(e,t,i){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const n=i(89207),a=i(59209),l=i(45204);e.exports=Backbone.View.extend({events:{"click .lightspeed-analyze":"analyze"},initialize(){this.$toggle=new a},render(){return this.$el.html(n.tpl("optimization/analyze")),this.$(".page-footer").append(this.$toggle.render()),this},analyze(){this.inLoading||(this.setLoading(!0),n.ajax("analyze","GET").then(e=>{Lightspeed.collections=[],Lightspeed.groups=Object.values(e).map(e=>(e.collection=new l(e.items.map(e=>r(r({},e),{},{optimized:!!parseInt(e.optimized)}))),Lightspeed.collections.push(e.collection),e)),this.setLoading(!1),Lightspeed.router.navigate("#optimization/analyze",{trigger:!0})}))},setLoading(e=!0){this.inLoading=e,this.$(".analyze-icon").toggleClass("loading",e)}})},14186:(e,t,i)=>{const o=i(89207),r=i(55302),s=i(28422);e.exports=Backbone.View.extend({initialize(){this.$progressBar=new r,this.optimizedItems=0,window.addEventListener("message",e=>{e.data&&"lightspeed-optimize"===e.data.from&&this.onOptimize(e.data)}),window.TVE_LS_API=this},resizeFrame:(e,t="all")=>new Promise(i=>{o.getOptimizationIframe(t).css("width",e+"px"),requestAnimationFrame(i)}),onOptimize(e){clearTimeout(this.waitingTimeout);let t=this.getOptimizingModel(e.id,e.key);this.optimizedItems++;const i={loading:!1,failed:void 0===t,optimized:void 0!==t};void 0===t&&Lightspeed.collections.find(e=>(t=e.findWhere({loading:!0}),!!t)),t&&t.set(i),this.optimizeItems()},render(){return this.$el.html(o.tpl("optimization/progress")),this.$(".progress-bar-wrapper").html(this.$progressBar.render()),Lightspeed.groups.forEach(e=>{const t=new s(e);this.$(".groups-to-optimize").append(t.render())}),setTimeout(()=>{Lightspeed.startedTime=performance.now(),this.optimizeItems()},24),this},updateProgress(){const e=o.getOptimizedItems(),t=o.getTotalItems();this.$progressBar.updateProgress(100*e/t);const i=(performance.now()-Lightspeed.startedTime)/1e3;this.$(".optimization-time").html(o.secondsToTime(i/this.optimizedItems*(t-e))),this.$(".optimized-items").html(e),this.$(".total-items").html(t);const r=o.getFailedItems();this.$(".failed-optimization-wrapper").toggle(0!==r),0!==r&&this.$(".optimization-failed-items").html(r)},optimizeItems(){this.updateProgress();const e=Lightspeed.collections.find(e=>!e.isOptimized());if(e){const t=e.getItemToOptimize();if(t){t.set("loading",!0),this.$(".item-in-progress").html(t.get("name"));const e=new URL(this.decodeUrl(t.get("url"))),i=["force-flat","force-all-js","tcb-lightspeed-optimize"];window.location.href.includes("#advanced/main")&&i.push("tcb-advanced-optimize"),i.forEach(t=>{e.searchParams.append(t,1)}),o.getOptimizationIframe().css("width","").attr("src",`${e.href}`),this.waitingTimeout=setTimeout(()=>{t.set({loading:!1,failed:!0,optimized:!1}),Lightspeed.startedTime-=Lightspeed.CONST.timeout,this.optimizeItems()},Lightspeed.CONST.timeout)}}else this.onFinished()},onFinished(){o.getOptimizationIframe().remove(),Lightspeed.router.navigate("#optimization/finished",{trigger:!0})},getOptimizingModel(e,t=""){let i=null;return Lightspeed.collections.find(o=>(i=o.findWhere({id:e,key:t}),!!i)),i||Lightspeed.collections.find(t=>(i=t.findWhere({id:e}),!!i)),i},decodeUrl:e=>e.replace(/&#038;/g,"&")})},28422:(e,t,i)=>{const o=i(89207);e.exports=Backbone.View.extend({className:"text-paragraph optimize-item",initialize(e){this.label=e.label,this.type=e.type,this.collection.each(e=>{e.set({failed:!1}),this.listenTo(e,"change",e=>{e.get("failed")&&e.set({group:this.label},{silent:!0}),this.render()})})},render(){return this.$el.html(o.tpl("optimization/group",{label:this.label,items:this.collection,status:this.collection.getStatus()})),this.$el}})},36418:(e,t,i)=>{function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,o)}return i}function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){s(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function s(e,t,i){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const n=i(89207),a={optimization:{label:lightspeed_localize.t.assets,url:"#optimization/main"},fonts:{label:lightspeed_localize.t.fonts,url:"#fonts/main"},advanced:{label:lightspeed_localize.t.advanced,url:"#advanced/main"}};e.exports=Backbone.View.extend({el:"#lightspeed-admin-wrapper",render(){this.$el.html(n.tpl("main")),Lightspeed.router.on("route",this.updateBreadcrumbs.bind(this))},updateBreadcrumbs(){const e=Backbone.history.getFragment().replace(/\/.*/g,""),t=this.$("#ls-menu-container").empty();Object.values(a).forEach(i=>{t.append(n.tpl("menu-item",r(r({},i),{},{currentRoute:e})))}),jQuery(".ls-breadcrumbs > span").html(a[e].label)}})},45204:e=>{e.exports=Backbone.Collection.extend({modelId:e=>`${e.id}-${e.key||"0"}`,isOptimized(){return this.models.every(e=>e.get("optimized")||e.get("failed"))},getItemToOptimize(){return this.find({optimized:!1,failed:!1})},resetOptimization(){this.each(e=>e.set({optimized:!1}))},getStatus(){let e;return e=this.findWhere({optimized:!1})?this.findWhere({loading:!0})?"running":this.findWhere({failed:!0})?"fail":"":"optimized",e}})},54991:(e,t,i)=>{e.exports={optimization:{main:i(5840),analyze:i(229),optimize:i(14186),finished:i(94539)},fonts:{main:i(1453)},advanced:{main:i(79907)}}},55302:(e,t,i)=>{const o=i(89207);e.exports=Backbone.View.extend({initialize(){this.model=new Backbone.Model({progress:0}),this.listenTo(this.model,"change",this.render.bind(this))},render(){return this.$el.html(o.tpl("progress-bar",{progress:this.model.get("progress")})),this.$el},updateProgress(e=0){e=parseInt(e),(isNaN(e)||e<0)&&(e=0),e>100&&(e=100),this.model.set("progress",e)}})},59209:(e,t,i)=>{const o=i(89207);e.exports=Backbone.View.extend({events:{"click .toggle-lightspeed":"toggleLightspeed"},className:"page-optimization-toggle",render(){return this.$el.html(o.tpl("optimization/toggle",{isEnabled:Lightspeed.CONST.options.is_enabled})),this.$el},toggleLightspeed(e){const t=e.currentTarget.checked?1:0;o.ajax("options","POST",{key:"_tve_enable_lightspeed",value:t}).then(()=>{Lightspeed.CONST.options.is_enabled=t,this.trigger("toggle",t)})}})},79907:(e,t,i)=>{function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,o)}return i}function r(e,t,i){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const s=i(89207),n=i(55302),a=i(45204),l=i(14186);e.exports=Backbone.View.extend({initialize(){this.initializeOptimize(),this.$progressBar=new n,this.optimizedItems=0},initializeOptimize(){this.optimize=new l,this.optimize.updateProgress=()=>{const e=s.getOptimizedItems(),t=s.getTotalItems();this.$progressBar.updateProgress(100*e/t)},this.optimize.$el=this.$el,this.optimize.onFinished=()=>{s.getOptimizationIframe().remove(),window.location.href.includes("#advanced/main")&&(this.$progressBar.updateProgress(100),this.$(".ls-save-advanced-settings").removeClass("tvd-disabled").text("Save"),this.$(".progress-bar-wrapper").hide())}},events:{"click .ls-save-advanced-settings":"saveAdvancedSettings"},render(){this.$el.html(s.tpl("advanced-settings/main",function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){r(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}({},Lightspeed.CONST.options))),this.$(".progress-bar-wrapper").html(this.$progressBar.render())},saveAdvancedSettings(){const e=[];this.$el.find(".ls-advanced-setting-input").each((t,i)=>{const o=i.dataset.key,r=i.checked?1:0;s.ajax("options","POST",{key:o,value:r}),Lightspeed.CONST.options[o]=r,i.checked&&e.push(i.dataset.key)}),this.advancedAssetsOptimize(e)},advancedAssetsOptimize(e){const t=[],i=e.some(e=>e.includes("woo")),o=e.some(e=>e.includes("gutenberg"));if(e.some(e=>e.includes("lp"))&&t.push("lp"),e.length&&e.some(e=>!e.includes("lp"))&&t.push("ttb"),this.$(".ls-save-advanced-settings").addClass("tvd-disabled").text("Saving"),this.$(".progress-bar-wrapper").show(),t.length)s.ajax("analyze","GET",{to_analyze:t}).then(e=>{Lightspeed.collections=[],Lightspeed.groups=Object.values(e).map(e=>(e.collection=new a(e.items.map(e=>(e.failed=!1,e.optimized=!0,i&&!e.woo_optimized&&(e.optimized=!1),o&&!e.gutenberg_optimized&&(e.optimized=!1),e))),Lightspeed.collections.push(e.collection),e)),this.optimize.optimizeItems()});else{let e=0;const t=setInterval(()=>{e<=100?this.$progressBar.updateProgress(e):(this.optimize.onFinished(),clearInterval(t)),e+=2},15)}},decodeUrl:e=>e.replace(/&#038;/g,"&")})},89207:e=>{var t;t=jQuery,e.exports={tpl(e,i={}){e.includes("lightspeed-")||(e=`lightspeed-${e}`);const o=t("script#"+e.replace(/\//g,"-")).html()||"";return _.template(o)(i)},secondsToTime(e=0){e=parseInt(e);const t=parseInt(e/3600),i=parseInt((e-3600*t)/60),o=e-3600*t-60*i;let r="";return t&&(r=`${t} hour${1===t?"":"s"}`),i&&(t&&(r+=", "),r+=`${i} minute${1===i?"":"s"} `),o&&((i||t)&&(r+=" and "),r+=`${o} second${1===o?"":"s"}`),r},getTotalItems:()=>Lightspeed.collections.reduce((e,t)=>e+t.length,0),getOptimizedItems:()=>Lightspeed.collections.reduce((e,t)=>e+t.where({optimized:!0}).length,0),getFailedItems:()=>Lightspeed.collections.reduce((e,t)=>e+t.where({failed:!0}).length,0),ajax:(e,i,o={})=>t.ajax({url:`${Lightspeed.CONST.route}/${e}`,headers:{"X-WP-Nonce":Lightspeed.CONST.nonce},type:i,data:o}),getOptimizationIframe(e="all"){const i=`lightspeed-optimization-iframe-${e}`;let o=t(`#${i}`);return 0===o.length&&(o=t(`<iframe id="${i}" class="tve-ls-optimization-frame">`).appendTo(t("body"))),o}}},94539:(e,t,i)=>{const o=i(89207);e.exports=Backbone.View.extend({events:{"click .go-to-home":()=>Lightspeed.router.navigate("#optimization/analyze",{trigger:!0}),"click .show-failed":"showFailedItems"},render(){return this.$el.html(o.tpl("optimization/finished",{optimizationTime:o.secondsToTime((performance.now()-Lightspeed.startedTime)/1e3),optimizedItems:o.getOptimizedItems(),failedItems:o.getFailedItems()})),this.$failedItems=this.$(".failed-items").hide(),this},showFailedItems(){this.$failedItems.empty();let e=1;Lightspeed.collections.forEach(t=>{t.where({optimized:!1}).forEach(t=>{this.$failedItems.append(o.tpl("optimization/failed-item",{index:e,group:t.get("group"),name:t.get("name")})),e++})}),this.$failedItems.slideDown()}})}},t={};function i(o){var r=t[o];if(void 0!==r)return r.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,i),s.exports}_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},Backbone.emulateHTTP=!0,jQuery(()=>{const e="#optimization/main",t=i(54991);window.Lightspeed={CONST:window.lightspeed_localize,groups:[],collections:{},router:new(Backbone.Router.extend({view:null,routes:{":view/:step":"loadView"},loadView(e,i){this.view&&(this.view.undelegateEvents(),this.view.$el.empty());const o=new(t[e]&&t[e][i]?t[e][i]:t.optimization.home)({el:"#ls-view-container"});this.view=o.render()}})),view:new(i(36418))},Lightspeed.CONST.timeout=1e3*parseInt(Lightspeed.CONST.timeout),Lightspeed.view.render(),Backbone.history.stop(),Backbone.history.start({hashchange:!0,silent:window.location.hash!==e}),Lightspeed.router.navigate(e,{trigger:!0})})})();